<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factura</title>
    <link rel="stylesheet" href="styles/factura.css">
    <link rel="stylesheet" href="styles/navbar.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
</head>

<body>
    <nav class="menu__nav">
        <a href="venta.html" class="menu__link">Salir</a>
    </nav>
    <main class="bill__container">
        <h2 class="bill__title">Factura de venta</h2>
        <div class="bill__outputs" id="form">
            <div class="bill__output">
                <p>Nombre: <span id="nombCli"></span></p>
                <p></p>
            </div>
            <div class="bill__output">
                <p>Rif: <span id="rifCli"></span></p>
                <p id="rifCli"></p>
            </div>
            <div class="bill__output">
                <p>Dirección: <span id="dirCli"></span></p>
                
            </div>
            <div class="bill__output">
                <p>Teléfono: <span id="telCli" ></span></p>
                <p ></p>
            </div>
            <div class="bill__output">
                <p>Número de Factura: <span id="numFact"></span></p>
                <p ></p>
            </div>
            <div class="bill__output">
                <p>Tipo de Pago: <span id="tipPago"></span></p>
                
            </div>
            <div class="bill__output">
                <p>Condición de pago: <span id="conPago"></span></p>
                <p ></p>
            </div>
        </div>
        <div class="bill__products">
            <div class="bill__output__legend">
                <p>Cantidad:</p>
                <p>Nombre de articulo:</p>
                <p>Precio Unitario:</p>
                <p>Precio:</p>


            </div>

            <!-- <div class="bill__product">
                <p id="item__cant">1</p>
                <p id="item__name">Pega</p>
                <p id="item__name">Pega</p>
                <p id="item__price">20</p>
            </div> -->

        </div>
        <div class="bill__total">
            <p>Subtotal: <span id="subTotal"></span> Bs</p>
            <p >IVA(16%): <span id="iva"></span> Bs</p>
            <p >Total: <span id="total"> </span> Bs</p>
        </div>
    </main>

    <div id="buttons">
        <button id="print">Imprimir</button>
        <button id="edit">Editar</button>
        <button id="del">Eliminar</button>
        <button id="anlr">Anular</button>
        <br>
        <button id="save">Guardar</button>
    </div>
    <article>

    <article class="modalEdit">

        <div>

            <form>
                
                <label>Nombre del Cliente</label>
                <input type="text" id="Nombre">
                <br>
                <label>RIF</label>
                <input type="text" id="Rif">
                 <label>Direccion</label>
                <input type="text" id="Dir">
                 <label>Telefono</label>
                <input type="text" id="Tlf">
                
                 <label>Tipo de pago</label>
                <input type="text" id="tip__P">
                 <label>Condicion de Pago</label>
                <input type="text" id="con__P">

            </form>
            <div class="articulos">

            </div>
            <button id="closeEdit">Cerrar</button>
            <button id="saveEdit">Guardar</button>
        </div>
        
        
    </article>
    
</article>
<!-- <script src="/scripts/venta.js"></script> -->
<script>

    //Botones de eventos en la factura
         const $btnEliminar = document.querySelector("#del");
         const $btnEditar = document.querySelector("#edit");
         const $btnPrint = document.querySelector("#print");
         const $btnAnlr = document.querySelector("#anlr");
         const $btnSave = document.querySelector("#save");
         let billContainer = document.querySelector(".bill__container");



        window.onload = function () {
            let codigoFactura = localStorage.getItem("facturaABuscar");
            if(codigoFactura){
                const facturas = localStorage.getItem("BDFactura");
                const bdfacturas = JSON.parse(facturas);
                console.log(bdfacturas[codigoFactura]);
                let nombCli = document.querySelector("#nombCli"),
                    rifCli = document.querySelector("#rifCli"),
                    dirCli = document.querySelector("#dirCli"),
                    telCli = document.querySelector("#telCli"),
                    numfact= document.querySelector("#numFact"),
                    tipPago = document.querySelector("#tipPago"),
                    conPago = document.querySelector("#conPago")

                nombCli.textContent = bdfacturas[codigoFactura].nombre;
                rifCli.textContent = bdfacturas[codigoFactura].rif;
                dirCli.textContent =bdfacturas[codigoFactura].direccion;
               telCli.textContent = bdfacturas[codigoFactura].tlf;
               tipPago.textContent = bdfacturas[codigoFactura].metodo;
               conPago.textContent = bdfacturas[codigoFactura].condicion;
               numFac.textContent = bdfacturas[codigoFactura].nroFactura

               let $cart = document.querySelector(".bill__products");
               let cart = bdfacturas[codigoFactura].articulos;
                cart.forEach((item, index, )=>{
              
                let contenedor = document.createElement("div");
    
                contenedor.classList.add("bill__product");
                $cart.appendChild(contenedor)
                
                
                let itemCant = document.createElement("p");
                itemCant.textContent = item.cantidad;
                contenedor.appendChild(itemCant);
                
                let itemName = document.createElement("p");
                itemName.textContent = item.nombre;
                contenedor.appendChild(itemName);
               
                
                let itemUnitPrice = document.createElement("p");
                itemUnitPrice.textContent = item.precio + " Bs";
                contenedor.appendChild(itemUnitPrice);

                let itemPrice = document.createElement("p");
                itemPrice.textContent = item.precioTotal + " Bs";
                contenedor.appendChild(itemPrice);
                
                
              
            });
                let subtotal = document.querySelector("#subTotal");
                let iva = document.querySelector("#iva");
                let total = document.querySelector("#total");
                subtotal.textContent = cart.reduce((sum , actual) => sum + actual.precioTotal , 0);
                 iva.textContent = (subtotal.textContent * 0.16).toFixed(2);
                total.textContent = (+subtotal.textContent + +iva.textContent).toFixed(2);
              
                if(bdfacturas[codigoFactura].anulado){
                     billContainer.style.opacity = "0.6";
                }
            }else{

                const clienteActual = localStorage.getItem("cliente");
                const productos = localStorage.getItem("productos");
                const facturas = localStorage.getItem("BDFactura");
                console.log(clienteActual);
                if (clienteActual) {
                    const cliente = JSON.parse(clienteActual);
                    const cart = JSON.parse(productos);
                    const bdfacturas = JSON.parse(facturas);
    
        
                   
    
                    console.log(bdfacturas)
            
                    let nombCli = document.querySelector("#nombCli"),
                        rifCli = document.querySelector("#rifCli"),
                        dirCli = document.querySelector("#dirCli"),
                        telCli = document.querySelector("#telCli"),
                        numFac = document.querySelector("#numFact"),
                        tipPago = document.querySelector("#tipPago"),
                        conPago = document.querySelector("#conPago")
    
                    nombCli.textContent = cliente.nombre;
                    rifCli.textContent = cliente.rif;
                    dirCli.textContent = cliente.direccion;
                   telCli.textContent = cliente.tlf;
                   numFac.textContent = String(bdfacturas.length).padStart(3, '0');
                   tipPago.textContent = cliente.metodo;
                   conPago.textContent = cliente.condicion;
    
                   let $cart = document.querySelector(".bill__products");
                    cart.forEach((item, index, )=>{
                    
                    let contenedor = document.createElement("div");
        
                    contenedor.classList.add("bill__product");
                    $cart.appendChild(contenedor)
                    
                    
                    let itemCant = document.createElement("p");
                    itemCant.textContent = item.cantidad;
                    contenedor.appendChild(itemCant);
                    
                    let itemName = document.createElement("p");
                    itemName.textContent = item.nombre;
                    contenedor.appendChild(itemName);
                   
                    
                    let itemUnitPrice = document.createElement("p");
                    itemUnitPrice.textContent = item.precio + " Bs";
                    contenedor.appendChild(itemUnitPrice);
    
                    let itemPrice = document.createElement("p");
                    itemPrice.textContent = item.precioTotal + " Bs";
                    contenedor.appendChild(itemPrice);
                    
                    
                  
                });
                    let subtotal = document.querySelector("#subTotal");
                    let iva = document.querySelector("#iva");
                    let total = document.querySelector("#total");
                    subtotal.textContent = cart.reduce((sum , actual) => sum + actual.precioTotal , 0);
                     iva.textContent = (subtotal.textContent * 0.16).toFixed(2);
                    total.textContent = (+subtotal.textContent + +iva.textContent).toFixed(2);
                    
                }
            }

        }

        //Editar factura
        const $editBtn = document.getElementById('edit');
const $closeEditBtn = document.getElementById('closeEdit');
const $saveEditBtn = document.getElementById('saveEdit');
 let nombCli = document.querySelector("#nombCli"),
    rifCli = document.querySelector("#rifCli"),
    dirCli = document.querySelector("#dirCli"),
    telCli = document.querySelector("#telCli"),
    numFac = document.querySelector("#numFact"),
    tipPago = document.querySelector("#tipPago"),
    conPago = document.querySelector("#conPago");
 let $inptNombCli = document.querySelector("#Nombre"),
    $inptRifCli = document.querySelector("#Rif"),
    $inptDirCli = document.querySelector("#Dir"),
    $inptTelCli = document.querySelector("#Tlf"),
    $inptNumFac = document.querySelector("#Num__Fact"),
    $inptTipPago = document.querySelector("#tip__P"),
    $inptConPago = document.querySelector("#con__P");
    const articulosContainer = document.querySelector('.articulos');

    // Mostrar artículos en el modal de edición
    function mostrarArticulosEnModal(cart) {
        articulosContainer.innerHTML = '';
        cart.forEach((item, idx) => {
            const div = document.createElement('div');
            div.classList.add('articulo-edit');
            div.innerHTML = `
                <label>Cantidad:</label>
                <input type="number" min="1" value="${item.cantidad}" data-idx="${idx}" class="edit-cantidad">
                <label>Nombre:</label>
                <input type="text" value="${item.nombre}" data-idx="${idx}" class="edit-nombre">
                <label>Precio Unitario:</label>
                <input type="number" min="0" step="0.01" value="${item.precio}" data-idx="${idx}" class="edit-precio">
            `;
            articulosContainer.appendChild(div);
        });
    }

    // Llenar el modal con los datos actuales al abrirlo
    $editBtn.addEventListener('click', () => {
        if (cart && Array.isArray(cart)) {
            mostrarArticulosEnModal(cart);
            // Llenar los inputs del modal con los datos actuales
            $inptNombCli.value = nombCli.textContent;
            $inptRifCli.value = rifCli.textContent;
            $inptDirCli.value = dirCli.textContent;
            $inptTelCli.value = telCli.textContent;
            $inptTipPago.value = tipPago.textContent;
            $inptConPago.value = conPago.textContent;
            // numFac solo si existe el input
            if ($inptNumFac) $inptNumFac.value = numFac.textContent;
        }
    });

    // Guardar cambios en los artículos
    function editarArticulos() {
        const cantidadInputs = document.querySelectorAll('.edit-cantidad');
        const nombreInputs = document.querySelectorAll('.edit-nombre');
        const precioInputs = document.querySelectorAll('.edit-precio');
        cantidadInputs.forEach((input, idx) => {
            cart[idx].cantidad = Number(input.value);
        });
        nombreInputs.forEach((input, idx) => {
            cart[idx].nombre = input.value;
        });
        precioInputs.forEach((input, idx) => {
            cart[idx].precio = Number(input.value);
            cart[idx].precioTotal = cart[idx].cantidad * cart[idx].precio;
        });
        // Actualizar en localStorage si corresponde
        localStorage.setItem("productos", JSON.stringify(cart));
        // Si la factura existe en BDFactura, actualizarla también
        let codigoFactura = localStorage.getItem("facturaABuscar");
       let indice = parseInt(numFac.textContent) - 1;
        
        if  (indice) {
            bdfacturas[indice].articulos = cart;

            // Actualizar también los datos del cliente si fueron editados
            bdfacturas[indice].nombre = $inptNombCli.value || nombCli.textContent;
            bdfacturas[indice].rif = $inptRifCli.value || rifCli.textContent;
            bdfacturas[indice].direccion = $inptDirCli.value || dirCli.textContent;
            bdfacturas[indice].tlf = $inptTelCli.value || telCli.textContent;
            bdfacturas[indice].metodo = $inptTipPago.value || tipPago.textContent;
            bdfacturas[indice].condicion = $inptConPago.value || conPago.textContent;
            console.log(bdfacturas)
            localStorage.setItem("BDFactura", JSON.stringify(bdfacturas));
        }
    }

    // Modificar editarDatos para incluir edición de artículos y actualizar todos los datos
    function editarDatos() {
        nombCli.textContent = $inptNombCli.value || nombCli.textContent;
        rifCli.textContent = $inptRifCli.value || rifCli.textContent;
        dirCli.textContent = $inptDirCli.value || dirCli.textContent;
        telCli.textContent = $inptTelCli.value || telCli.textContent;
        numFac.textContent = $inptNumFac ? ($inptNumFac.value || numFac.textContent) : numFac.textContent;
        tipPago.textContent = $inptTipPago.value || tipPago.textContent;
        conPago.textContent = $inptConPago.value || conPago.textContent;
        editarArticulos();
        $inptNombCli.value = '';
        $inptRifCli.value = '';
        $inptDirCli.value = '';
        $inptTelCli.value = '';
        if ($inptNumFac) $inptNumFac.value = '';
        $inptTipPago.value = '';
        $inptConPago.value = '';
        // Recargar productos en la factura
        const $cart = document.querySelector(".bill__products");
        $cart.innerHTML = '';
        cart.forEach((item) => {
            let contenedor = document.createElement("div");
            contenedor.classList.add("bill__product");
            let itemCant = document.createElement("p");
            itemCant.textContent = item.cantidad;
            contenedor.appendChild(itemCant);
            let itemName = document.createElement("p");
            itemName.textContent = item.nombre;
            contenedor.appendChild(itemName);
            let itemUnitPrice = document.createElement("p");
            itemUnitPrice.textContent = item.precio + " Bs";
            contenedor.appendChild(itemUnitPrice);
            let itemPrice = document.createElement("p");
            itemPrice.textContent = item.precioTotal + " Bs";
            contenedor.appendChild(itemPrice);
            $cart.appendChild(contenedor);
        });
        let subtotal = document.querySelector("#subTotal");
        let iva = document.querySelector("#iva");
        let total = document.querySelector("#total");
        subtotal.textContent = cart.reduce((sum , actual) => sum + actual.precioTotal , 0);
        iva.textContent = (subtotal.textContent * 0.16).toFixed(2);
        total.textContent = (+subtotal.textContent + +iva.textContent).toFixed(2);
    }



$editBtn.addEventListener('click', (e) => {
    e.preventDefault();
    document.querySelector(".modalEdit").style.display = "block";
});

$closeEditBtn.addEventListener('click', (e) => {
    e.preventDefault();
    document.querySelector(".modalEdit").style.display = "none";
    $inptNombCli.value = '';
    $inptRifCli.value = '';
    $inptDirCli.value = '';
    $inptTelCli.value = '';
    $inptNumFac.value = '';
    $inptTipPago.value = '';
    $inptConPago.value = '';
});

$saveEditBtn.addEventListener('click', (e) => {
    e.preventDefault();
    editarDatos();
    document.querySelector(".modalEdit").style.display = "none";})


//Eliminar factura


 const clienteActual = localStorage.getItem("cliente");
 const productos = localStorage.getItem("productos");
 const facturas = localStorage.getItem("BDFactura");

 const cliente = JSON.parse(clienteActual);
 const cart = JSON.parse(productos);
 const bdfacturas = JSON.parse(facturas);


 console.log(cliente);
console.log(bdfacturas);

$btnEliminar.addEventListener("click", (e)=>{
    bdfacturas.forEach((element, idx) => {
        console.log(element);
        if(element.nroFactura === cliente.nroFactura){
            
            bdfacturas.splice(idx, 1);
            
            console.log(bdfacturas)
            
            $btnEditar.disabled = true;
            $btnPrint.disabled = true;
            $btnEliminar.disabled = true;
            $btnAnlr.disabled = true;
            billContainer.style.opacity = "0.6";
            localStorage.setItem('BDFactura', JSON.stringify(bdfacturas))
        }
    });

    // BDFactura.splice(idx, 1);
    // localStorage.setItem('BDPorCobrar', JSON.stringify(BDPorCobrar));
})
$btnAnlr.addEventListener("click", (e)=>{
    bdfacturas.forEach((element, idx) => {
        console.log(element);
        if(element.nroFactura === cliente.nroFactura){
    
            if(bdfacturas[idx].anulado){
                bdfacturas[idx].anulado = false;
                billContainer.style.opacity = "1";
            }else{

                $btnEditar.disabled = true;
                $btnPrint.disabled = true;
                $btnEliminar.disabled = true;
                
                bdfacturas[idx].anulado= true;
                billContainer.style.opacity = "0.6";
            }
            localStorage.setItem('BDFactura', JSON.stringify(bdfacturas));
        }
    });
    
    // BDFactura.splice(idx, 1);
    // localStorage.setItem('BDPorCobrar', JSON.stringify(BDPorCobrar));
});
$btnSave.addEventListener("click", (e)=>{
    alert("Guardado exitoso")
    localStorage.setItem('BDFactura', JSON.stringify(bdfacturas));

    window.location.href = "venta.html";
})



        let printBtn = document.querySelector("#print");

        printBtn.addEventListener("click", (e)=>{
            window.print();
        })
    </script>

<!-- <script src="scripts/anular.js"></script>
<script src="scripts/factura.js"></script> -->
</body>

</html>